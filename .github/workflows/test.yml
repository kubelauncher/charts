name: Integration Tests

on:
  push:
    branches: [main]
    paths:
      - "charts/**"
      - "tests/**"
      - ".github/workflows/test.yml"
  pull_request:
    branches: [main]
    paths:
      - "charts/**"
      - "tests/**"
      - ".github/workflows/test.yml"
  workflow_dispatch:
    inputs:
      charts:
        description: "Comma-separated list of charts to test (empty = changed only)"
        required: false
        default: ""

permissions:
  contents: read
  packages: read

jobs:
  detect-charts:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_charts: ${{ steps.set-matrix.outputs.has_charts }}
      all_charts: ${{ steps.set-matrix.outputs.all_charts }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: set-matrix
        run: |
          # Define all test configurations
          declare -A TESTS
          TESTS[redis]='standalone no-auth custom-config'
          TESTS[postgresql]='default postgres-only custom-port'
          TESTS[rabbitmq]='single custom-plugins'
          TESTS[kubectl]='job cronjob'
          TESTS[mysql]='default custom-config'
          TESTS[mariadb]='default custom-config'
          TESTS[mongodb]='default auth-enabled'
          TESTS[memcached]='default'
          TESTS[kafka]='kraft'
          TESTS[zookeeper]='standalone'
          TESTS[cassandra]='single'
          TESTS[keycloak]='dev'
          TESTS[openldap]='default'

          # Determine which charts to test
          CHARTS_TO_TEST=()

          # workflow_dispatch with specific charts
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ inputs.charts }}" ]; then
            IFS=',' read -ra CHARTS_TO_TEST <<< "${{ inputs.charts }}"
          # workflow_dispatch without charts = test all existing test directories
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            for dir in tests/*/; do
              [ -d "$dir" ] && CHARTS_TO_TEST+=("$(basename "$dir")")
            done
          # push/PR = detect changed charts
          else
            BASE_SHA="${{ github.event.before }}"
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              BASE_SHA="${{ github.event.pull_request.base.sha }}"
            fi

            # Get changed files
            CHANGED_FILES=$(git diff --name-only "$BASE_SHA" HEAD 2>/dev/null || git diff --name-only HEAD~1 HEAD)

            # Detect changed charts
            for file in $CHANGED_FILES; do
              if [[ "$file" =~ ^charts/([^/]+)/ ]]; then
                chart="${BASH_REMATCH[1]}"
                if [[ ! " ${CHARTS_TO_TEST[*]} " =~ " ${chart} " ]]; then
                  CHARTS_TO_TEST+=("$chart")
                fi
              fi
              if [[ "$file" =~ ^tests/([^/]+)/ ]]; then
                chart="${BASH_REMATCH[1]}"
                if [[ ! " ${CHARTS_TO_TEST[*]} " =~ " ${chart} " ]]; then
                  CHARTS_TO_TEST+=("$chart")
                fi
              fi
              # If workflow file changed, test all
              if [[ "$file" == ".github/workflows/test.yml" ]]; then
                CHARTS_TO_TEST=()
                for dir in tests/*/; do
                  [ -d "$dir" ] && CHARTS_TO_TEST+=("$(basename "$dir")")
                done
                break
              fi
            done
          fi

          # Build matrix JSON
          MATRIX_ITEMS=()
          for chart in "${CHARTS_TO_TEST[@]}"; do
            # Skip if no tests defined
            [ -z "${TESTS[$chart]}" ] && continue
            # Skip if test directory doesn't exist
            [ ! -d "tests/$chart" ] && continue

            for test_name in ${TESTS[$chart]}; do
              values_file="tests/${chart}/values-${test_name}.yaml"
              [ -f "$values_file" ] || continue
              MATRIX_ITEMS+=("{\"chart\":\"${chart}\",\"test_name\":\"${test_name}\",\"values\":\"${values_file}\"}")
            done
          done

          if [ ${#MATRIX_ITEMS[@]} -eq 0 ]; then
            echo "has_charts=false" >> "$GITHUB_OUTPUT"
            echo "matrix={\"include\":[]}" >> "$GITHUB_OUTPUT"
          else
            MATRIX_JSON=$(IFS=,; echo "[${MATRIX_ITEMS[*]}]")
            echo "has_charts=true" >> "$GITHUB_OUTPUT"
            echo "matrix={\"include\":${MATRIX_JSON}}" >> "$GITHUB_OUTPUT"
          fi

          # List of all charts for lint job
          ALL_CHARTS=$(ls -d charts/*/ 2>/dev/null | xargs -I{} basename {} | jq -R . | jq -s -c .)
          echo "all_charts=${ALL_CHARTS}" >> "$GITHUB_OUTPUT"

          echo "Charts to test: ${CHARTS_TO_TEST[*]:-none}"
          echo "Matrix items: ${#MATRIX_ITEMS[@]}"

  lint:
    needs: detect-charts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: azure/setup-helm@v4

      - name: Install helm-docs
        run: |
          HELM_DOCS_VERSION="1.14.2"
          curl -fsSL "https://github.com/norwoodj/helm-docs/releases/download/v${HELM_DOCS_VERSION}/helm-docs_${HELM_DOCS_VERSION}_Linux_x86_64.tar.gz" \
            | tar xz -C /usr/local/bin helm-docs

      - name: Verify helm-docs are up to date
        run: |
          helm-docs --chart-search-root charts
          if ! git diff --quiet charts/*/README.md; then
            echo "ERROR: helm-docs are out of date. Run 'helm-docs --chart-search-root charts' and commit the result."
            git diff charts/*/README.md
            exit 1
          fi

      - name: Lint all charts
        run: |
          for chart in charts/*/; do
            echo "--- Linting ${chart} ---"
            helm lint "$chart" --strict
          done

      - name: Template dry-run (all charts)
        run: |
          for chart in charts/*/; do
            name=$(basename "$chart")
            echo "--- Templating ${name} ---"
            helm template "test-${name}" "$chart" > /dev/null
          done

      - name: Template with test values
        run: |
          for values_file in tests/*/values-*.yaml; do
            [ -f "$values_file" ] || continue
            chart=$(echo "$values_file" | cut -d/ -f2)
            [ -d "charts/${chart}" ] || continue
            echo "--- Template ${chart} with ${values_file} ---"
            helm template "test" "charts/${chart}" -f "$values_file" > /dev/null
          done

  integration:
    needs: [detect-charts, lint]
    if: needs.detect-charts.outputs.has_charts == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-charts.outputs.matrix) }}

    name: "${{ matrix.chart }} / ${{ matrix.test_name }}"

    steps:
      - uses: actions/checkout@v4

      - uses: azure/setup-helm@v4

      - name: Create kind cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: chart-test

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull and load images into kind
        run: |
          TAG=$(grep -oP 'appVersion:\s*"?\K[^"]+' "charts/${{ matrix.chart }}/Chart.yaml")
          IMAGE="ghcr.io/${{ github.repository_owner }}/${{ matrix.chart }}:${TAG}"

          echo "Pulling ${IMAGE}..."
          docker pull "${IMAGE}" || {
            echo "Image not found on GHCR, skipping"
            exit 0
          }
          kind load docker-image "${IMAGE}" --name chart-test

      - name: Run smoke tests
        run: |
          chmod +x tests/smoke-test.sh
          ./tests/smoke-test.sh \
            "${{ matrix.chart }}" \
            "test-${{ matrix.chart }}-${{ matrix.test_name }}" \
            "${{ matrix.values }}"

      - name: Dump debug info on failure
        if: failure()
        run: |
          NS="test-test-${{ matrix.chart }}-${{ matrix.test_name }}"
          echo "=== Pods ==="
          kubectl get pods -n "${NS}" -o wide 2>/dev/null || true
          echo ""
          echo "=== StatefulSets ==="
          kubectl get statefulsets -n "${NS}" -o wide 2>/dev/null || true
          echo ""
          echo "=== PVCs ==="
          kubectl get pvc -n "${NS}" -o wide 2>/dev/null || true
          echo ""
          echo "=== Services ==="
          kubectl get svc -n "${NS}" 2>/dev/null || true
          echo ""
          echo "=== Events (last 50) ==="
          kubectl get events -n "${NS}" --sort-by='.lastTimestamp' 2>/dev/null | tail -50 || true
          echo ""
          echo "=== Describe StatefulSets ==="
          kubectl describe statefulsets -n "${NS}" 2>/dev/null || true
          echo ""
          echo "=== Describe Pods ==="
          kubectl describe pods -n "${NS}" 2>/dev/null || true
          echo ""
          echo "=== Pod Logs ==="
          for pod in $(kubectl get pods -n "${NS}" -o jsonpath='{.items[*].metadata.name}' 2>/dev/null); do
            echo "--- Logs: ${pod} ---"
            kubectl logs -n "${NS}" "${pod}" --all-containers --tail=100 2>/dev/null || true
            echo "--- Previous Logs: ${pod} ---"
            kubectl logs -n "${NS}" "${pod}" --all-containers --previous --tail=50 2>/dev/null || true
          done
