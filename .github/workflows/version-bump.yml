name: Auto Version Bump

on:
  pull_request:
    branches: [main]
    paths:
      - "charts/**/Chart.yaml"
      - "charts/**/values.yaml"

permissions:
  contents: write
  pull-requests: write

jobs:
  version-bump:
    runs-on: ubuntu-latest
    # Only run on Renovate PRs
    if: github.actor == 'renovate[bot]' || github.actor == 'renovate'
    steps:
      - uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Get changed charts
        id: changed
        run: |
          CHARTS=$(git diff --name-only origin/main...HEAD | grep -E '(Chart|values)\.yaml' | xargs -I{} dirname {} | sort -u)
          echo "charts<<EOF" >> "$GITHUB_OUTPUT"
          echo "$CHARTS" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Bump chart versions
        id: bump
        run: |
          BUMPED=""
          for chart_dir in ${{ steps.changed.outputs.charts }}; do
            CHART_FILE="${chart_dir}/Chart.yaml"
            VALUES_FILE="${chart_dir}/values.yaml"
            [ -f "$CHART_FILE" ] || continue
            [ -f "$VALUES_FILE" ] || continue

            CHART_NAME=$(basename "$chart_dir")

            # Detect what changed in values.yaml
            OLD_TAG=$(git show origin/main:"$VALUES_FILE" 2>/dev/null | grep '^\s*tag:' | head -1 | awk '{print $2}' | tr -d '"' || echo "")
            NEW_TAG=$(grep '^\s*tag:' "$VALUES_FILE" | head -1 | awk '{print $2}' | tr -d '"')
            OLD_DIGEST=$(git show origin/main:"$VALUES_FILE" 2>/dev/null | grep '^\s*digest:' | head -1 | awk '{print $2}' | tr -d '"' || echo "")
            NEW_DIGEST=$(grep '^\s*digest:' "$VALUES_FILE" | head -1 | awk '{print $2}' | tr -d '"')

            # Also check appVersion changes in Chart.yaml (backward compat)
            OLD_APP_VERSION=$(git show origin/main:"$CHART_FILE" 2>/dev/null | grep '^appVersion:' | awk '{print $2}' | tr -d '"' || echo "")
            NEW_APP_VERSION=$(grep '^appVersion:' "$CHART_FILE" | awk '{print $2}' | tr -d '"')

            TAG_CHANGED=false
            DIGEST_CHANGED=false

            if [ -n "$NEW_TAG" ] && [ "$NEW_TAG" != "$OLD_TAG" ]; then
              TAG_CHANGED=true
            fi
            if [ -n "$NEW_DIGEST" ] && [ "$NEW_DIGEST" != "$OLD_DIGEST" ]; then
              DIGEST_CHANGED=true
            fi

            # Skip if nothing changed
            if [ "$TAG_CHANGED" = false ] && [ "$DIGEST_CHANGED" = false ] && [ "$NEW_APP_VERSION" = "$OLD_APP_VERSION" ]; then
              continue
            fi

            # If tag changed in values.yaml, sync appVersion in Chart.yaml
            if [ "$TAG_CHANGED" = true ]; then
              sed -i "s/^appVersion: .*/appVersion: \"${NEW_TAG}\"/" "$CHART_FILE"
              NEW_APP_VERSION="$NEW_TAG"

              # Determine bump type from tag version comparison
              OLD_MAJOR=$(echo "${OLD_TAG#v}" | cut -d. -f1)
              OLD_MINOR=$(echo "${OLD_TAG#v}" | cut -d. -f2)
              NEW_MAJOR=$(echo "${NEW_TAG#v}" | cut -d. -f1)
              NEW_MINOR=$(echo "${NEW_TAG#v}" | cut -d. -f2)

              if [ "$NEW_MAJOR" != "$OLD_MAJOR" ]; then
                BUMP_TYPE="major"
              elif [ "$NEW_MINOR" != "$OLD_MINOR" ]; then
                BUMP_TYPE="minor"
              else
                BUMP_TYPE="patch"
              fi
            elif [ "$DIGEST_CHANGED" = true ]; then
              # Digest-only change (OS rebuild, same tag)
              BUMP_TYPE="patch"
            elif [ "$NEW_APP_VERSION" != "$OLD_APP_VERSION" ]; then
              # Legacy: appVersion changed directly in Chart.yaml
              OLD_MAJOR=$(echo "${OLD_APP_VERSION#v}" | cut -d. -f1)
              OLD_MINOR=$(echo "${OLD_APP_VERSION#v}" | cut -d. -f2)
              NEW_MAJOR=$(echo "${NEW_APP_VERSION#v}" | cut -d. -f1)
              NEW_MINOR=$(echo "${NEW_APP_VERSION#v}" | cut -d. -f2)

              if [ "$NEW_MAJOR" != "$OLD_MAJOR" ]; then
                BUMP_TYPE="major"
              elif [ "$NEW_MINOR" != "$OLD_MINOR" ]; then
                BUMP_TYPE="minor"
              else
                BUMP_TYPE="patch"
              fi
            fi

            # Get current chart version
            CHART_VERSION=$(grep '^version:' "$CHART_FILE" | awk '{print $2}' | tr -d '"')
            CHART_MAJOR=$(echo "$CHART_VERSION" | cut -d. -f1)
            CHART_MINOR=$(echo "$CHART_VERSION" | cut -d. -f2)
            CHART_PATCH=$(echo "$CHART_VERSION" | cut -d. -f3)

            # Calculate new chart version
            case "$BUMP_TYPE" in
              major)
                NEW_CHART_VERSION="$((CHART_MAJOR + 1)).0.0"
                ;;
              minor)
                NEW_CHART_VERSION="${CHART_MAJOR}.$((CHART_MINOR + 1)).0"
                ;;
              patch)
                NEW_CHART_VERSION="${CHART_MAJOR}.${CHART_MINOR}.$((CHART_PATCH + 1))"
                ;;
            esac

            # Update Chart.yaml version
            sed -i "s/^version: .*/version: \"${NEW_CHART_VERSION}\"/" "$CHART_FILE"

            # Update changelog annotation
            if [ "$TAG_CHANGED" = true ] || [ "$NEW_APP_VERSION" != "$OLD_APP_VERSION" ]; then
              # Tag changed: upstream release changelog
              python3 - "$CHART_FILE" "$CHART_NAME" "$NEW_APP_VERSION" << 'PYEOF'
          import sys, re

          chart_file, chart_name, version = sys.argv[1], sys.argv[2], sys.argv[3]

          urls = {
              "redis": f"https://github.com/redis/redis/releases/tag/{version}",
              "postgresql": f"https://www.postgresql.org/docs/release/{version.replace('.', '-')}/",
              "mongodb": f"https://www.mongodb.com/docs/manual/release-notes/{'.'.join(version.split('.')[:2])}/",
              "mysql": f"https://dev.mysql.com/doc/relnotes/mysql/{'.'.join(version.split('.')[:2])}/en/",
              "mariadb": f"https://mariadb.com/kb/en/mariadb-{version.replace('.', '')}-release-notes/",
              "kafka": f"https://github.com/apache/kafka/releases/tag/{version}",
              "rabbitmq": f"https://github.com/rabbitmq/rabbitmq-server/releases/tag/v{version}",
              "cassandra": f"https://github.com/apache/cassandra/releases/tag/cassandra-{version}",
              "memcached": f"https://github.com/memcached/memcached/releases/tag/{version}",
              "zookeeper": f"https://github.com/apache/zookeeper/releases/tag/release-{version}",
              "keycloak": f"https://github.com/keycloak/keycloak/releases/tag/{version}",
              "openldap": f"https://git.openldap.org/openldap/openldap/-/tags/OPENLDAP_REL_ENG_{version.replace('.', '_')}",
              "kubectl": f"https://github.com/kubernetes/kubernetes/releases/tag/v{version}",
              "etcd": f"https://github.com/etcd-io/etcd/releases/tag/v{version}",
          }

          url = urls.get(chart_name, "")
          changelog = f"    artifacthub.io/changes: |\n"
          changelog += f"      - kind: changed\n"
          changelog += f"        description: Update {chart_name} to {version}\n"
          if url:
              changelog += f"        links:\n"
              changelog += f"          - name: Release Notes\n"
              changelog += f"            url: {url}\n"

          with open(chart_file) as f:
              content = f.read()

          content = re.sub(
              r'    artifacthub\.io/changes: \|.*?(?=\n    [a-zA-Z]|\nannotations:|\n[a-z])',
              changelog.rstrip(),
              content,
              flags=re.DOTALL
          )

          with open(chart_file, 'w') as f:
              f.write(content)
          PYEOF
              echo "Bumped $CHART_NAME: $CHART_VERSION -> $NEW_CHART_VERSION ($BUMP_TYPE, appVersion: $OLD_APP_VERSION -> $NEW_APP_VERSION)"
            else
              # Digest-only change: rebuild changelog
              python3 - "$CHART_FILE" "$CHART_NAME" << 'PYEOF'
          import sys, re

          chart_file, chart_name = sys.argv[1], sys.argv[2]

          changelog = f"    artifacthub.io/changes: |\n"
          changelog += f"      - kind: changed\n"
          changelog += f"        description: Rebuild {chart_name} image (updated base OS)\n"

          with open(chart_file) as f:
              content = f.read()

          content = re.sub(
              r'    artifacthub\.io/changes: \|.*?(?=\n    [a-zA-Z]|\nannotations:|\n[a-z])',
              changelog.rstrip(),
              content,
              flags=re.DOTALL
          )

          with open(chart_file, 'w') as f:
              f.write(content)
          PYEOF
              echo "Bumped $CHART_NAME: $CHART_VERSION -> $NEW_CHART_VERSION (digest-only rebuild)"
            fi

            BUMPED="${BUMPED}${CHART_NAME} "
          done

          echo "bumped=${BUMPED}" >> "$GITHUB_OUTPUT"

      - name: Install helm-docs
        if: steps.bump.outputs.bumped != ''
        run: |
          HELM_DOCS_VERSION="1.14.2"
          curl -fsSL "https://github.com/norwoodj/helm-docs/releases/download/v${HELM_DOCS_VERSION}/helm-docs_${HELM_DOCS_VERSION}_Linux_x86_64.tar.gz" \
            | tar xz -C /usr/local/bin helm-docs

      - name: Install helm-values-schema-json
        if: steps.bump.outputs.bumped != ''
        run: |
          SCHEMA_VERSION="2.3.1"
          curl -fsSL "https://github.com/losisin/helm-values-schema-json/releases/download/v${SCHEMA_VERSION}/helm-values-schema-json_${SCHEMA_VERSION}_linux_amd64.tgz" \
            | tar xz -C /usr/local/bin schema

      - name: Regenerate helm-docs and schemas
        if: steps.bump.outputs.bumped != ''
        run: |
          helm-docs --chart-search-root charts
          for chart in charts/*/; do
            name=$(basename "$chart")
            echo "Generating schema for ${name}..."
            schema --values "${chart}values.yaml" --output "${chart}values.schema.json"
          done

      - name: Import GPG key
        if: steps.bump.outputs.bumped != ''
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          git_user_signingkey: true
          git_commit_gpgsign: true

      - name: Commit version bump
        if: steps.bump.outputs.bumped != ''
        run: |
          git config user.name "KubeLauncher"
          git config user.email "platform@kubelauncher.com"
          git add charts/*/Chart.yaml charts/*/values.yaml charts/*/README.md charts/*/values.schema.json
          git diff --staged --quiet || git commit -S -m "chore: bump chart versions and regenerate docs"
          git push
