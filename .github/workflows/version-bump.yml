name: Sync Chart Versions

on:
  pull_request:
    branches: [main]
    paths:
      - "charts/**/Chart.yaml"

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-versions:
    runs-on: ubuntu-latest
    # Only run on Renovate PRs
    if: github.actor == 'renovate[bot]' || github.actor == 'renovate'
    steps:
      - uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Get changed Chart.yaml files
        id: changed
        run: |
          CHARTS=$(git diff --name-only origin/main...HEAD | grep 'Chart.yaml' | xargs -I{} dirname {} | sort -u)
          echo "charts<<EOF" >> "$GITHUB_OUTPUT"
          echo "$CHARTS" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Sync chart version to appVersion
        id: sync
        run: |
          SYNCED=""
          for chart_dir in ${{ steps.changed.outputs.charts }}; do
            CHART_FILE="${chart_dir}/Chart.yaml"
            [ -f "$CHART_FILE" ] || continue

            # Get appVersion and current chart version
            APP_VERSION=$(grep '^appVersion:' "$CHART_FILE" | awk '{print $2}' | tr -d '"')
            CHART_VERSION=$(grep '^version:' "$CHART_FILE" | awk '{print $2}' | tr -d '"')

            # Skip if already in sync
            [ "$CHART_VERSION" = "$APP_VERSION" ] && continue

            # Update chart version to match appVersion
            sed -i "s/^version: .*/version: \"${APP_VERSION}\"/" "$CHART_FILE"

            CHART_NAME=$(basename "$chart_dir")
            echo "Synced $CHART_NAME: version $CHART_VERSION -> $APP_VERSION"
            SYNCED="${SYNCED}${CHART_NAME} "
          done

          echo "synced=${SYNCED}" >> "$GITHUB_OUTPUT"

      - name: Commit version sync
        if: steps.sync.outputs.synced != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add charts/*/Chart.yaml
          git diff --staged --quiet || git commit -m "chore: sync chart versions to appVersion"
          git push
