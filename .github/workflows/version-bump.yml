name: Auto Version Bump

on:
  pull_request:
    branches: [main]
    paths:
      - "charts/**/Chart.yaml"

permissions:
  contents: write
  pull-requests: write

jobs:
  version-bump:
    runs-on: ubuntu-latest
    # Only run on Renovate PRs
    if: github.actor == 'renovate[bot]' || github.actor == 'renovate'
    steps:
      - uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Get changed Chart.yaml files
        id: changed
        run: |
          CHARTS=$(git diff --name-only origin/main...HEAD | grep 'Chart.yaml' | xargs -I{} dirname {} | sort -u)
          echo "charts<<EOF" >> "$GITHUB_OUTPUT"
          echo "$CHARTS" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Bump chart versions
        id: bump
        run: |
          BUMPED=""
          for chart_dir in ${{ steps.changed.outputs.charts }}; do
            CHART_FILE="${chart_dir}/Chart.yaml"
            [ -f "$CHART_FILE" ] || continue

            # Get current and previous appVersion
            NEW_APP_VERSION=$(grep '^appVersion:' "$CHART_FILE" | awk '{print $2}' | tr -d '"')
            OLD_APP_VERSION=$(git show origin/main:"$CHART_FILE" 2>/dev/null | grep '^appVersion:' | awk '{print $2}' | tr -d '"' || echo "")

            # Skip if appVersion didn't change or is new chart
            [ -z "$OLD_APP_VERSION" ] && continue
            [ "$NEW_APP_VERSION" = "$OLD_APP_VERSION" ] && continue

            # Parse versions (strip leading v if present)
            OLD_MAJOR=$(echo "${OLD_APP_VERSION#v}" | cut -d. -f1)
            OLD_MINOR=$(echo "${OLD_APP_VERSION#v}" | cut -d. -f2)
            NEW_MAJOR=$(echo "${NEW_APP_VERSION#v}" | cut -d. -f1)
            NEW_MINOR=$(echo "${NEW_APP_VERSION#v}" | cut -d. -f2)

            # Determine bump type
            if [ "$NEW_MAJOR" != "$OLD_MAJOR" ]; then
              BUMP_TYPE="major"
            elif [ "$NEW_MINOR" != "$OLD_MINOR" ]; then
              BUMP_TYPE="minor"
            else
              BUMP_TYPE="patch"
            fi

            # Get current chart version
            CHART_VERSION=$(grep '^version:' "$CHART_FILE" | awk '{print $2}' | tr -d '"')
            CHART_MAJOR=$(echo "$CHART_VERSION" | cut -d. -f1)
            CHART_MINOR=$(echo "$CHART_VERSION" | cut -d. -f2)
            CHART_PATCH=$(echo "$CHART_VERSION" | cut -d. -f3)

            # Calculate new chart version
            case "$BUMP_TYPE" in
              major)
                NEW_CHART_VERSION="$((CHART_MAJOR + 1)).0.0"
                ;;
              minor)
                NEW_CHART_VERSION="${CHART_MAJOR}.$((CHART_MINOR + 1)).0"
                ;;
              patch)
                NEW_CHART_VERSION="${CHART_MAJOR}.${CHART_MINOR}.$((CHART_PATCH + 1))"
                ;;
            esac

            # Update Chart.yaml
            sed -i "s/^version: .*/version: \"${NEW_CHART_VERSION}\"/" "$CHART_FILE"

            # Update changelog annotation with upstream release link
            CHART_NAME=$(basename "$chart_dir")
            python3 - "$CHART_FILE" "$CHART_NAME" "$NEW_APP_VERSION" << 'PYEOF'
            import sys, re

            chart_file, chart_name, version = sys.argv[1], sys.argv[2], sys.argv[3]

            urls = {
                "redis": f"https://github.com/redis/redis/releases/tag/{version}",
                "postgresql": f"https://www.postgresql.org/docs/release/{version.replace('.', '-')}/",
                "mongodb": f"https://www.mongodb.com/docs/manual/release-notes/{'.'.join(version.split('.')[:2])}/",
                "mysql": f"https://dev.mysql.com/doc/relnotes/mysql/{'.'.join(version.split('.')[:2])}/en/",
                "mariadb": f"https://mariadb.com/kb/en/mariadb-{version.replace('.', '')}-release-notes/",
                "kafka": f"https://github.com/apache/kafka/releases/tag/{version}",
                "rabbitmq": f"https://github.com/rabbitmq/rabbitmq-server/releases/tag/v{version}",
                "cassandra": f"https://github.com/apache/cassandra/releases/tag/cassandra-{version}",
                "memcached": f"https://github.com/memcached/memcached/releases/tag/{version}",
                "zookeeper": f"https://github.com/apache/zookeeper/releases/tag/release-{version}",
                "keycloak": f"https://github.com/keycloak/keycloak/releases/tag/{version}",
                "openldap": f"https://git.openldap.org/openldap/openldap/-/tags/OPENLDAP_REL_ENG_{version.replace('.', '_')}",
                "kubectl": f"https://github.com/kubernetes/kubernetes/releases/tag/v{version}",
            }

            url = urls.get(chart_name, "")
            changelog = f"    artifacthub.io/changes: |\n"
            changelog += f"      - kind: changed\n"
            changelog += f"        description: Update {chart_name} to {version}\n"
            if url:
                changelog += f"        links:\n"
                changelog += f"          - name: Release Notes\n"
                changelog += f"            url: {url}\n"

            with open(chart_file) as f:
                content = f.read()

            content = re.sub(
                r'    artifacthub\.io/changes: \|.*?(?=\n    [a-zA-Z]|\nannotations:|\n[a-z])',
                changelog.rstrip(),
                content,
                flags=re.DOTALL
            )

            with open(chart_file, 'w') as f:
                f.write(content)
            PYEOF
            echo "Bumped $CHART_NAME: $CHART_VERSION -> $NEW_CHART_VERSION ($BUMP_TYPE, appVersion: $OLD_APP_VERSION -> $NEW_APP_VERSION)"
            BUMPED="${BUMPED}${CHART_NAME} "
          done

          echo "bumped=${BUMPED}" >> "$GITHUB_OUTPUT"

      - name: Install helm-docs
        if: steps.bump.outputs.bumped != ''
        run: |
          HELM_DOCS_VERSION="1.14.2"
          curl -fsSL "https://github.com/norwoodj/helm-docs/releases/download/v${HELM_DOCS_VERSION}/helm-docs_${HELM_DOCS_VERSION}_Linux_x86_64.tar.gz" \
            | tar xz -C /usr/local/bin helm-docs

      - name: Install helm-values-schema-json
        if: steps.bump.outputs.bumped != ''
        run: |
          SCHEMA_VERSION="2.3.1"
          curl -fsSL "https://github.com/losisin/helm-values-schema-json/releases/download/v${SCHEMA_VERSION}/helm-values-schema-json_${SCHEMA_VERSION}_linux_amd64.tgz" \
            | tar xz -C /usr/local/bin schema

      - name: Regenerate helm-docs and schemas
        if: steps.bump.outputs.bumped != ''
        run: |
          helm-docs --chart-search-root charts
          for chart in charts/*/; do
            name=$(basename "$chart")
            echo "Generating schema for ${name}..."
            schema --values "${chart}values.yaml" --output "${chart}values.schema.json"
          done

      - name: Commit version bump
        if: steps.bump.outputs.bumped != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add charts/*/Chart.yaml charts/*/README.md charts/*/values.schema.json
          git diff --staged --quiet || git commit -m "chore: bump chart versions and regenerate docs"
          git push
