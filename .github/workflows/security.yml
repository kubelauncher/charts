name: Security Scan

on:
  push:
    branches: [main]
    paths:
      - "charts/**"
  pull_request:
    branches: [main]
    paths:
      - "charts/**"
  schedule:
    # Daily at 6 AM UTC
    - cron: "0 6 * * *"
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  kubescape:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: azure/setup-helm@v4

      - name: Install Kubescape
        run: |
          curl -s https://raw.githubusercontent.com/kubescape/kubescape/master/install.sh | /bin/bash
          echo "${HOME}/.kubescape/bin" >> "$GITHUB_PATH"

      - name: Scan Helm charts with Kubescape
        run: |
          # Template all charts to a single file for scanning
          COMBINED_YAML="/tmp/all-charts.yaml"
          > "$COMBINED_YAML"

          for chart in charts/*/; do
            name=$(basename "$chart")
            echo "=== Templating ${name} ==="
            helm template "test-${name}" "$chart" >> "$COMBINED_YAML" 2>/dev/null || true
            echo "---" >> "$COMBINED_YAML"
          done

          echo "=== Running Kubescape scan ==="
          kubescape scan "$COMBINED_YAML" \
            --format sarif \
            --output kubescape-results.sarif \
            --severity-threshold high \
            || true

      - name: Upload Kubescape results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: kubescape-results.sarif
        continue-on-error: true

  helm-lint-strict:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: azure/setup-helm@v4

      - name: Strict lint all charts
        run: |
          FAILED=0
          for chart in charts/*/; do
            name=$(basename "$chart")
            echo "=== Linting ${name} ==="

            if ! helm lint "$chart" --strict --with-subcharts; then
              FAILED=1
            fi
          done

          exit $FAILED

  check-deprecated-apis:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: azure/setup-helm@v4

      - name: Install pluto
        run: |
          PLUTO_VERSION=$(curl -s https://api.github.com/repos/FairwindsOps/pluto/releases/latest | grep '"tag_name"' | cut -d'"' -f4)
          curl -fsSL "https://github.com/FairwindsOps/pluto/releases/download/${PLUTO_VERSION}/pluto_${PLUTO_VERSION#v}_linux_amd64.tar.gz" | tar xz
          sudo mv pluto /usr/local/bin/

      - name: Check for deprecated Kubernetes APIs
        run: |
          for chart in charts/*/; do
            name=$(basename "$chart")
            echo "=== Checking ${name} for deprecated APIs ==="

            helm template "test-${name}" "$chart" 2>/dev/null | pluto detect - || true
          done
